<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VietLongCrypto â€” Thá»‹ TrÆ°á»ng Tiá»n áº¢o</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080c14;--surface:#0d1320;--surface2:#111928;
  --border:rgba(99,179,237,0.08);
  --accent:#00d4ff;--accent2:#7c3aed;
  --green:#00e676;--red:#ff3d57;--gold:#f59e0b;
  --text:#e2e8f0;--muted:#64748b;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:Cambria,'Times New Roman',serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;z-index:0;}
.orb{position:fixed;border-radius:50%;filter:blur(130px);pointer-events:none;z-index:0;opacity:.1;}
.orb1{width:800px;height:800px;background:var(--accent2);top:-350px;right:-250px;}
.orb2{width:700px;height:700px;background:#0ea5e9;bottom:-350px;left:-200px;}

/* Ticker */
.ticker-wrap{background:var(--surface);border-bottom:1px solid var(--border);overflow:hidden;position:sticky;top:0;z-index:100;}
.ticker{display:flex;animation:tickAnim 180s linear infinite;white-space:nowrap;padding:8px 0;}
.ticker:hover{animation-play-state:paused;}
.ticker-item{display:inline-flex;align-items:center;gap:6px;padding:0 18px;font-size:11px;border-right:1px solid var(--border);flex-shrink:0;}
.ticker-item img{width:14px;height:14px;border-radius:50%;object-fit:cover;}
.tsym{color:var(--accent);font-weight:700;}.tup{color:var(--green);}.tdn{color:var(--red);}
@keyframes tickAnim{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* Header */
header{position:relative;z-index:10;padding:14px 36px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(8,12,20,.65);backdrop-filter:blur(14px);}
.logo{display:flex;align-items:center;gap:13px;cursor:default;}
.logo-coin{width:42px;height:42px;flex-shrink:0;filter:drop-shadow(0 0 10px rgba(0,212,255,.5));animation:coinFlip 8s linear infinite;}
@keyframes coinFlip{0%,40%{transform:rotateY(0deg)}50%{transform:rotateY(90deg)}60%,100%{transform:rotateY(180deg)}}
.logo-text{font-family:'Orbitron',sans-serif;font-size:19px;font-weight:900;letter-spacing:2px;line-height:1;background:linear-gradient(90deg,#00d4ff 0%,#a78bfa 50%,#00d4ff 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:shimmer 4s linear infinite;filter:drop-shadow(0 0 8px rgba(0,212,255,.3));}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.header-right{display:flex;align-items:center;gap:22px;}
.header-stats{display:flex;gap:22px;}
.header-stat .label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.header-stat .value{font-size:13px;margin-top:2px;font-weight:600;}
.clock{font-size:12px;color:var(--muted);font-weight:600;white-space:nowrap;}
.clock .tz{font-size:9px;color:var(--muted);opacity:.7;margin-left:4px;}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.22);border-radius:20px;padding:4px 13px;font-size:11px;color:var(--green);font-weight:700;letter-spacing:1px;}
.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.65)}}

/* Layout */
main{position:relative;z-index:10;max-width:1640px;margin:0 auto;padding:24px 36px;display:grid;grid-template-columns:1fr 350px;gap:20px;}
.stats-row{grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.market-col{grid-column:1;}
.news-col{grid-column:2;grid-row:2/4;}

/* Stat Cards */
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:16px 18px;position:relative;overflow:hidden;transition:border-color .25s,transform .25s;}
.stat-card:hover{border-color:rgba(0,212,255,.2);transform:translateY(-2px);}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));opacity:0;transition:opacity .25s;}
.stat-card:hover::after{opacity:1;}
.sc-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px;}
.sc-value{font-size:18px;font-weight:700;}
.sc-sub{font-size:11px;color:var(--muted);margin-top:3px;}
.sc-emoji{position:absolute;top:13px;right:15px;font-size:22px;opacity:.1;}

/* Table */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.table-toolbar{padding:11px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.tabs{display:flex;gap:3px;background:var(--surface2);border-radius:7px;padding:3px;}
.tab{padding:5px 12px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;border:none;background:none;color:var(--muted);}
.tab.active{background:var(--accent);color:#000;}
.tab:hover:not(.active){color:var(--text);}
.search-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 12px;width:180px;transition:border-color .2s;}
.search-box:focus-within{border-color:rgba(0,212,255,.3);}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-family:Cambria,'Times New Roman',serif;font-size:12px;width:100%;}
.search-box input::placeholder{color:var(--muted);}
.clear-btn{background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;line-height:1;padding:0 2px;transition:color .15s;display:none;flex-shrink:0;}
.clear-btn:hover{color:var(--red);}
.clear-btn.visible{display:block;}
.ws-status{font-size:10px;color:var(--muted);}
.coin-count-badge{font-size:10px;color:var(--accent);background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.14);border-radius:10px;padding:2px 9px;}
.table-scroll{overflow-y:auto;max-height:700px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.table-scroll::-webkit-scrollbar{width:4px;}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(99,179,237,.15);border-radius:2px;}
table{width:100%;border-collapse:collapse;}
thead th{position:sticky;top:0;background:var(--surface2);padding:9px 14px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;z-index:2;}
thead th.r{text-align:right;}
tbody tr{border-bottom:1px solid rgba(255,255,255,.02);transition:background .12s;}
tbody tr:hover{background:rgba(0,212,255,.04);}
tbody tr:last-child{border-bottom:none;}
td{padding:9px 14px;font-size:12px;white-space:nowrap;}
td.r{text-align:right;}
.rank{color:var(--muted);font-size:10px;}
.coin-cell{display:flex;align-items:center;gap:9px;}
/* Real logo image */
.coin-logo{width:30px;height:30px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--surface2);}
.coin-logo-fallback{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
.coin-name{font-weight:700;font-size:12px;}
.coin-sym{font-size:10px;color:var(--muted);margin-top:1px;}
.price-val{font-size:12px;font-weight:700;}
.flash-green{animation:fG .55s ease;}
.flash-red{animation:fR .55s ease;}
@keyframes fG{0%,100%{color:var(--text)}40%{color:var(--green)}}
@keyframes fR{0%,100%{color:var(--text)}40%{color:var(--red)}}
.badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;display:inline-block;min-width:66px;text-align:center;}
.badge.up{color:var(--green);background:rgba(0,230,118,.09);}
.badge.down{color:var(--red);background:rgba(255,61,87,.09);}
.badge.neu{color:var(--muted);background:rgba(100,116,139,.09);}
.num{font-size:10px;color:var(--muted);}

/* News Panel */
.news-panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;max-height:790px;}
.news-header{padding:13px 17px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.news-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;display:flex;align-items:center;gap:7px;}
.news-title svg{width:14px;height:14px;fill:var(--accent);}
.news-source-tabs{display:flex;gap:4px;padding:9px 17px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none;}
.news-source-tabs::-webkit-scrollbar{display:none;}
.news-source-tab{font-size:10px;font-weight:700;padding:3px 9px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;transition:all .2s;white-space:nowrap;}
.news-source-tab.active{border-color:rgba(0,212,255,.4);color:var(--accent);background:rgba(0,212,255,.07);}
.news-refresh-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 9px;color:var(--muted);font-size:10px;cursor:pointer;transition:all .2s;font-family:Cambria,'Times New Roman',serif;}
.news-refresh-btn:hover{color:var(--accent);border-color:rgba(0,212,255,.3);}
.news-refresh-btn:disabled{opacity:.4;cursor:not-allowed;}
.news-feed{overflow-y:auto;flex:1;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.news-feed::-webkit-scrollbar{width:4px;}
.news-feed::-webkit-scrollbar-thumb{background:rgba(99,179,237,.15);border-radius:2px;}
.news-item{padding:13px 17px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .13s;text-decoration:none;display:block;color:inherit;}
.news-item:hover{background:rgba(0,212,255,.04);}
.news-item:last-child{border-bottom:none;}
.news-meta{display:flex;align-items:center;gap:6px;margin-bottom:6px;flex-wrap:wrap;}
.news-src-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;background:rgba(0,212,255,.08);color:var(--accent);border:1px solid rgba(0,212,255,.14);}
.news-sentiment{font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;}
.news-sentiment.bullish{color:var(--green);background:rgba(0,230,118,.1);}
.news-sentiment.bearish{color:var(--red);background:rgba(255,61,87,.1);}
.news-sentiment.neutral{color:var(--gold);background:rgba(245,158,11,.1);}
.news-time{font-size:9px;color:var(--muted);margin-left:auto;}
.news-headline{font-size:12px;font-weight:600;line-height:1.45;color:var(--text);margin-bottom:4px;}
.news-summary{font-size:11px;color:var(--muted);line-height:1.5;}
.news-coins{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}
.news-coin-tag{font-size:9px;color:var(--accent);background:rgba(0,212,255,.07);border:1px solid rgba(0,212,255,.12);border-radius:3px;padding:1px 5px;}
.news-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:36px;gap:10px;color:var(--muted);font-size:12px;text-align:center;}
.news-spinner{width:26px;height:26px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
.state-box{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px;gap:12px;color:var(--muted);font-size:12px;text-align:center;}
.spinner{width:34px;height:34px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .75s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border-top:1px solid var(--border);flex-wrap:wrap;}
.pg-btn{background:none;border:1px solid var(--border);border-radius:5px;padding:4px 10px;color:var(--muted);font-size:11px;cursor:pointer;transition:all .2s;font-family:Cambria,'Times New Roman',serif;}
.pg-btn:hover:not(:disabled){border-color:rgba(0,212,255,.35);color:var(--accent);}
.pg-btn.active{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700;}
.pg-btn:disabled{opacity:.35;cursor:not-allowed;}
.pg-info{font-size:11px;color:var(--muted);margin:0 8px;}
footer{position:relative;z-index:10;text-align:center;padding:18px;color:var(--muted);font-size:11px;border-top:1px solid var(--border);}
footer .hl{color:var(--accent);}
@media(max-width:1100px){main{grid-template-columns:1fr;}.news-col{grid-column:1;grid-row:auto;}.news-panel{max-height:500px;}}
@media(max-width:768px){header{padding:12px 14px;}.header-stats{display:none;}main{padding:12px;}.stats-row{grid-template-columns:repeat(2,1fr);}.hide-sm{display:none!important;}}
</style>
</head>
<body>
<div class="orb orb1"></div><div class="orb orb2"></div>

<!-- Ticker -->
<div class="ticker-wrap"><div class="ticker" id="ticker"><span class="ticker-item"><span class="tsym">â³ Äang táº£i dá»¯ liá»‡u...</span></span></div></div>

<!-- Header -->
<header>
  <div class="logo">
    <svg class="logo-coin" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="cg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00d4ff"/><stop offset="50%" stop-color="#7c3aed"/><stop offset="100%" stop-color="#00d4ff"/></linearGradient>
        <linearGradient id="cf" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1e3a5f"/><stop offset="100%" stop-color="#0d1320"/></linearGradient>
        <radialGradient id="cs" cx="35%" cy="30%"><stop offset="0%" stop-color="rgba(0,212,255,0.28)"/><stop offset="100%" stop-color="rgba(0,0,0,0)"/></radialGradient>
        <filter id="gl"><feGaussianBlur stdDeviation="1.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <circle cx="22" cy="22" r="21" fill="url(#cg)"/>
      <circle cx="22" cy="22" r="18.5" fill="url(#cf)"/>
      <circle cx="22" cy="22" r="18.5" fill="url(#cs)"/>
      <circle cx="22" cy="22" r="16" fill="none" stroke="rgba(0,212,255,0.2)" stroke-width="0.6"/>
      <text x="22" y="18" text-anchor="middle" font-family="Cambria" font-weight="800" font-size="6" fill="url(#cg)" filter="url(#gl)">VLC</text>
      <path d="M14 22 L22 30 L30 22" fill="none" stroke="url(#cg)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" filter="url(#gl)"/>
    </svg>
    <div class="logo-text">VietLongCrypto</div>
  </div>
  <div class="header-right">
    <div class="header-stats">
      <div class="header-stat"><div class="label">KL Giao Dá»‹ch 24h</div><div class="value" id="hVol">â€”</div></div>
      <div class="header-stat"><div class="label">BTC Dominance</div><div class="value" id="hBtcDom">â€”</div></div>
      <div class="header-stat"><div class="label">Theo DÃµi</div><div class="value" id="hCount">â€”</div></div>
    </div>
    <div class="clock" id="clock">â€”<span class="tz">UTC+7</span></div>
    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
  </div>
</header>

<main>
  <div class="stats-row">
    <div class="stat-card"><div class="sc-label">Coins Äang Theo DÃµi</div><div class="sc-value" id="sCoinCount">â€”</div><div class="sc-sub" id="sLastUpdate">Äang táº£i dá»¯ liá»‡u...</div><div class="sc-emoji">ğŸ“¡</div></div>
    <div class="stat-card"><div class="sc-label">TÄƒng Máº¡nh Nháº¥t 24h</div><div class="sc-value" id="sTopGain" style="color:var(--green)">â€”</div><div class="sc-sub" id="sTopGainName">â€”</div><div class="sc-emoji">ğŸš€</div></div>
    <div class="stat-card"><div class="sc-label">Giáº£m Máº¡nh Nháº¥t 24h</div><div class="sc-value" id="sTopLoss" style="color:var(--red)">â€”</div><div class="sc-sub" id="sTopLossName">â€”</div><div class="sc-emoji">ğŸ“‰</div></div>
    <div class="stat-card"><div class="sc-label">TÄƒng / Giáº£m / Ngang</div><div class="sc-value" id="sRatio">â€”</div><div class="sc-sub">Trong danh sÃ¡ch theo dÃµi</div><div class="sc-emoji">âš–ï¸</div></div>
  </div>

  <!-- Market Table -->
  <div class="market-col">
    <div class="table-wrap">
      <div class="table-toolbar">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="tabs">
            <button class="tab active" onclick="setTab(this,'all')">Táº¥t Cáº£</button>
            <button class="tab" onclick="setTab(this,'gainers')">ğŸŸ¢ TÄƒng</button>
            <button class="tab" onclick="setTab(this,'losers')">ğŸ”´ Giáº£m</button>
          </div>
          <span class="coin-count-badge" id="coinCountBadge">â€”</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="ws-status" id="wsStatus">â³ Äang káº¿t ná»‘i...</span>
          <div class="search-box">
            <span style="color:var(--muted);font-size:12px">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="TÃ¬m coin..." oninput="onSearch()" onkeydown="if(event.key==='Escape')clearSearch()">
            <button class="clear-btn" id="clearBtn" onclick="clearSearch()" title="XÃ³a tÃ¬m kiáº¿m">âœ•</button>
          </div>
        </div>
      </div>
      <div class="table-scroll">
        <div id="tableArea"><div class="state-box"><div class="spinner"></div><div>Äang táº£i táº¥t cáº£ coins tá»« Binance...</div></div></div>
      </div>
    </div>
  </div>

  <!-- News Panel -->
  <div class="news-col">
    <div class="news-panel">
      <div class="news-header">
        <div class="news-title">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
          Tin Tá»©c Crypto
        </div>
        <button class="news-refresh-btn" id="newsRefreshBtn" onclick="fetchNews()">â†» LÃ m má»›i</button>
      </div>
      <div class="news-source-tabs">
        <button class="news-source-tab active" onclick="filterNews(this,'all')">Táº¥t Cáº£</button>
        <button class="news-source-tab" onclick="filterNews(this,'CoinDesk')">CoinDesk</button>
        <button class="news-source-tab" onclick="filterNews(this,'CoinTelegraph')">CoinTelegraph</button>
        <button class="news-source-tab" onclick="filterNews(this,'Bitcoin Mag')">Bitcoin Mag</button>
      </div>
      <div class="news-feed" id="newsFeed">
        <div class="news-loading"><div class="news-spinner"></div><div>Äang táº£i tin tá»©c...</div></div>
      </div>
    </div>
  </div>
</main>

<footer>GiÃ¡ realtime tá»« <span class="hl">Binance</span> Â· Logo & Tin tá»©c tá»« <span class="hl">CoinGecko</span> Â· MÃºi giá» <span class="hl">UTC+7 (HÃ  Ná»™i)</span> Â· Â© 2026 <span class="hl">VietLongCrypto</span></footer>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTC+7 CLOCK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tickClock(){
  const now = new Date();
  // UTC+7 offset = UTC + 7 hours
  const utc7 = new Date(now.getTime() + (7 * 60 * 60 * 1000));
  const hh = String(utc7.getUTCHours()).padStart(2,'0');
  const mm = String(utc7.getUTCMinutes()).padStart(2,'0');
  const ss = String(utc7.getUTCSeconds()).padStart(2,'0');
  const dd = String(utc7.getUTCDate()).padStart(2,'0');
  const mo = String(utc7.getUTCMonth()+1).padStart(2,'0');
  const yyyy = utc7.getUTCFullYear();
  document.getElementById('clock').innerHTML =
    `${hh}:${mm}:${ss} &nbsp;${dd}/${mo}/${yyyy}<span class="tz">UTC+7</span>`;
}
setInterval(tickClock, 1000);
tickClock();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIME AGO â€” UTC+7 aware
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function timeAgo(ms){
  const s = Math.floor((Date.now() - ms) / 1000);
  if(s < 60)    return s + 'g trÆ°á»›c';
  if(s < 3600)  return Math.floor(s/60) + ' phÃºt trÆ°á»›c';
  if(s < 86400) return Math.floor(s/3600) + ' giá» trÆ°á»›c';
  return Math.floor(s/86400) + ' ngÃ y trÆ°á»›c';
}

function fmtDateVN(ms){
  const d = new Date(ms + 7*3600000); // shift to UTC+7
  return d.toUTCString().replace('GMT','').trim().slice(0,-4)+' ICT';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMATTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtP(p){
  if(!p) return 'â€”';
  if(p>=10000) return '$'+p.toLocaleString('en',{maximumFractionDigits:0});
  if(p>=1000)  return '$'+p.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2});
  if(p>=1)     return '$'+p.toFixed(4);
  if(p>=0.001) return '$'+p.toFixed(5);
  return '$'+p.toFixed(8);
}
function fmtB(n){
  if(!n) return 'â€”';
  if(n>=1e12) return '$'+(n/1e12).toFixed(2)+'T';
  if(n>=1e9)  return '$'+(n/1e9).toFixed(2)+'B';
  if(n>=1e6)  return '$'+(n/1e6).toFixed(2)+'M';
  return '$'+(n/1e3).toFixed(2)+'K';
}
function sign(n){ return n>=0?'+':''; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let SYMBOLS   = [];   // ['BTCUSDT', ...]
const coins   = {};   // sym â†’ {price,prev,change24h,high,low,vol}
const hist    = {};   // sym â†’ [price, ...]
const logoMap = {};   // base â†’ imageURL from CoinGecko
const nameMap = {};   // base â†’ full name
const colorMap= {};   // base â†’ fallback color

let currentTab = 'all';
let ws = null, reconnTimer = null;
let firstData = false;
let currentPage = 1;
const PAGE_SIZE = 100; // rows per page â€” renders fast, user can page through all coins

const FALLBACK_COLORS = ['#e2761b','#6c86eb','#f59e0b','#10b981','#ef4444','#8b5cf6','#06b6d4','#f97316','#84cc16','#ec4899'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 1: Binance REST â†’ top 100 USDT by volume
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadTop100(){
  try{
    const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
    if(!res.ok) throw new Error('Binance HTTP '+res.status);
    const data = await res.json();

    const stables = new Set(['USDT','BUSD','USDC','DAI','TUSD','USDP','FDUSD','PYUSD','USDE','USDX','USDD','GUSD','FRAX','LUSD']);
    // Keep ALL valid USDT pairs â€” no slice limit
    const filtered = data
      .filter(t => t.symbol.endsWith('USDT'))
      .filter(t => {
        const b = t.symbol.replace('USDT','');
        return !stables.has(b)
          && !/^(UP|DOWN|BULL|BEAR)\w+USDT$/.test(t.symbol)
          && parseFloat(t.quoteVolume) > 0;   // must have some volume
      })
      .sort((a,b) => parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume));
    // No .slice() â€” take everything

    SYMBOLS = filtered.map(t => t.symbol);
    filtered.forEach(t => {
      const base = t.symbol.replace('USDT','');
      coins[t.symbol] = {
        price:     parseFloat(t.lastPrice)||0,
        prev:      parseFloat(t.lastPrice)||0,
        change24h: parseFloat(t.priceChangePercent)||0,
        high:      parseFloat(t.highPrice)||0,
        low:       parseFloat(t.lowPrice)||0,
        vol:       parseFloat(t.quoteVolume)||0,
      };
      hist[t.symbol] = [];
      colorMap[base] = FALLBACK_COLORS[base.charCodeAt(0) % FALLBACK_COLORS.length];
      nameMap[base]  = base;
    });

    firstData = true;
    render();

    // Enrich with CoinGecko logos+names
    loadCoinGeckoLogos();
    // Connect WebSocket(s) â€” split into chunks of 180 streams per connection
    connectWS();

  }catch(e){
    document.getElementById('tableArea').innerHTML=
      '<div class="state-box"><div style="font-size:26px">âš ï¸</div><div>KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u Binance.<br>Vui lÃ²ng táº£i láº¡i trang.</div></div>';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 2: CoinGecko â€” logos + names (free, CORS ok)
   /api/v3/coins/markets â€” returns 250 coins per page
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadCoinGeckoLogos(){
  // Fetch multiple pages to get logos for as many coins as possible
  // CoinGecko free tier: 250 per page, we fetch pages 1-4 sequentially
  const pages = [1,2,3,4];
  for(const page of pages){
    try{
      // Small delay between requests to respect rate limits
      if(page > 1) await new Promise(r=>setTimeout(r, 1200));
      const res = await fetch(
        `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=${page}&sparkline=false`
      );
      if(!res.ok) break; // stop on rate limit or error
      const data = await res.json();
      if(!data.length) break;
      data.forEach(c => {
        const sym = c.symbol.toUpperCase();
        if(!logoMap[sym]){
          logoMap[sym] = c.image;
          nameMap[sym] = c.name;
        }
      });
      render(); // re-render after each page
    }catch(e){
      break; // silent fail â€” logos are enhancement only
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 3: Binance WebSocket realtime
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Binance allows max 200 streams per WebSocket connection
// We split SYMBOLS into chunks and open multiple WS connections
const wsConnections = [];

function handleWsMessage(evt){
  try{
    const d = JSON.parse(evt.data).data;
    if(!d||!d.s||!coins[d.s]) return;
    const c = coins[d.s];
    c.prev      = c.price;
    c.price     = parseFloat(d.c)||0;
    c.change24h = parseFloat(d.P)||0;
    c.high      = parseFloat(d.h)||0;
    c.low       = parseFloat(d.l)||0;
    c.vol       = parseFloat(d.q)||0;
    const h = hist[d.s]||(hist[d.s]=[]);
    h.push(c.price); if(h.length>30) h.shift();
  }catch(e){}
}

function connectWS(){
  // Close any existing connections
  wsConnections.forEach(w=>{ try{w.close();}catch(e){} });
  wsConnections.length = 0;

  const CHUNK = 180; // safe below Binance's 200 limit
  let openCount = 0;

  for(let i=0; i<SYMBOLS.length; i+=CHUNK){
    const chunk = SYMBOLS.slice(i, i+CHUNK);
    const streams = chunk.map(s=>s.toLowerCase()+'@ticker').join('/');
    const sock = new WebSocket('wss://stream.binance.com:9443/stream?streams='+streams);

    sock.onopen = ()=>{
      openCount++;
      const total = Math.ceil(SYMBOLS.length/CHUNK);
      document.getElementById('wsStatus').textContent=`ğŸŸ¢ ${openCount}/${total} káº¿t ná»‘i live`;
      document.getElementById('sLastUpdate').textContent='Dá»¯ liá»‡u thá»i gian thá»±c tá»« Binance';
      clearTimeout(reconnTimer);
    };
    sock.onmessage = handleWsMessage;
    sock.onerror = ()=>{ document.getElementById('wsStatus').textContent='ğŸ”´ Má»™t káº¿t ná»‘i lá»—i'; };
    sock.onclose = ()=>{
      openCount = Math.max(0, openCount-1);
      document.getElementById('wsStatus').textContent='ğŸŸ¡ Äang thá»­ láº¡i...';
      // Reconnect all after short delay
      clearTimeout(reconnTimer);
      reconnTimer = setTimeout(connectWS, 5000);
    };
    wsConnections.push(sock);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPARKLINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sparkSVG(sym){
  const h = hist[sym]||[];
  if(h.length<2) return '<svg width="68" height="22"></svg>';
  const mn=Math.min(...h),mx=Math.max(...h),rng=mx-mn||1;
  const pts=h.map((v,i)=>{
    const x=2+(i/(h.length-1))*64, y=20-((v-mn)/rng)*18;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  const clr=h[h.length-1]>=h[0]?'#00e676':'#ff3d57';
  return `<svg width="68" height="22" viewBox="0 0 68 22" style="display:block"><polyline points="${pts}" fill="none" stroke="${clr}" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COIN LOGO HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function coinLogoHTML(base){
  if(logoMap[base]){
    return `<img class="coin-logo" src="${logoMap[base]}" alt="${base}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
            <div class="coin-logo-fallback" style="display:none;background:${colorMap[base]}22;border:1px solid ${colorMap[base]}40;color:${colorMap[base]}">${base[0]}</div>`;
  }
  return `<div class="coin-logo-fallback" style="background:${colorMap[base]}22;border:1px solid ${colorMap[base]}40;color:${colorMap[base]}">${base[0]}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  if(!firstData) return;
  const q = (document.getElementById('searchInput').value||'').toLowerCase().trim();

  let list = SYMBOLS.map(s=>{
    const base = s.replace('USDT','');
    return { sym:s, base, ...coins[s] };
  });

  if(currentTab==='gainers') list=list.filter(c=>c.change24h>0).sort((a,b)=>b.change24h-a.change24h);
  else if(currentTab==='losers') list=list.filter(c=>c.change24h<0).sort((a,b)=>a.change24h-b.change24h);
  else list.sort((a,b)=>b.vol-a.vol);

  if(q) list=list.filter(c=>{
    const name=(nameMap[c.base]||'').toLowerCase();
    return name.includes(q)||c.base.toLowerCase().includes(q);
  });

  // Update stats
  const all = SYMBOLS.map(s=>({base:s.replace('USDT',''),...coins[s]})).filter(c=>c.price>0);
  if(all.length){
    const sorted = [...all].sort((a,b)=>b.change24h-a.change24h);
    const top=sorted[0], bot=sorted[sorted.length-1];
    const up=all.filter(c=>c.change24h>0.01).length;
    const dn=all.filter(c=>c.change24h<-0.01).length;
    const totalVol=all.reduce((s,c)=>s+c.vol,0);
    const btc=all.find(c=>c.base==='BTC');
    const btcMcap=btc?btc.price*19700000:0;
    const totalMcap=all.reduce((s,c)=>s+c.price*(c.base==='BTC'?19700000:c.base==='ETH'?120000000:1e9),0);

    document.getElementById('sCoinCount').textContent   = all.length+' Coins';
    document.getElementById('sTopGain').textContent     = `+${(top.change24h||0).toFixed(2)}%`;
    document.getElementById('sTopGainName').textContent = nameMap[top.base]||top.base;
    document.getElementById('sTopLoss').textContent     = `${(bot.change24h||0).toFixed(2)}%`;
    document.getElementById('sTopLossName').textContent = nameMap[bot.base]||bot.base;
    document.getElementById('sRatio').textContent       = `${up} â–² / ${dn} â–¼ / ${all.length-up-dn} â€”`;
    document.getElementById('hVol').textContent         = fmtB(totalVol);
    document.getElementById('hBtcDom').textContent      = totalMcap?((btcMcap/totalMcap)*100).toFixed(1)+'%':'â€”';
    document.getElementById('hCount').textContent       = all.length+' coins';
    document.getElementById('coinCountBadge').textContent = list.length+' coins';
  }

  updateTicker();

  if(!list.length){
    document.getElementById('tableArea').innerHTML='<div class="state-box"><div>KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£</div></div>';
    return;
  }

  // Pagination
  const totalPages = Math.ceil(list.length / PAGE_SIZE);
  if(currentPage > totalPages) currentPage = 1;
  const startIdx = (currentPage-1)*PAGE_SIZE;
  const pageList = list.slice(startIdx, startIdx+PAGE_SIZE);

  const rows = pageList.map((c,i)=>{
    const cls = c.change24h>0.01?'up':c.change24h<-0.01?'down':'neu';
    const fl  = c.price&&c.prev&&c.price!==c.prev?(c.price>c.prev?'flash-green':'flash-red'):'';
    const fullName = nameMap[c.base]||c.base;
    return `<tr>
      <td><span class="rank">${startIdx+i+1}</span></td>
      <td><div class="coin-cell">
        ${coinLogoHTML(c.base)}
        <div><div class="coin-name">${fullName}</div><div class="coin-sym">${c.base}</div></div>
      </div></td>
      <td class="r"><span class="price-val ${fl}">${fmtP(c.price)}</span></td>
      <td class="r"><span class="badge ${cls}">${sign(c.change24h)}${c.change24h.toFixed(2)}%</span></td>
      <td class="r hide-sm"><span class="num">${fmtP(c.high)}</span></td>
      <td class="r hide-sm"><span class="num">${fmtP(c.low)}</span></td>
      <td class="r hide-sm"><span class="num">${fmtB(c.vol)}</span></td>
      <td class="r hide-sm">${sparkSVG(c.sym)}</td>
    </tr>`;
  }).join('');

  // Build pagination controls
  let pgHtml = '';
  if(totalPages > 1){
    const maxBtns = 7;
    let startPg = Math.max(1, currentPage - Math.floor(maxBtns/2));
    let endPg   = Math.min(totalPages, startPg + maxBtns - 1);
    if(endPg - startPg < maxBtns - 1) startPg = Math.max(1, endPg - maxBtns + 1);

    pgHtml = '<div class="pagination">';
    pgHtml += `<button class="pg-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>â€¹</button>`;
    if(startPg > 1) pgHtml += `<button class="pg-btn" onclick="goPage(1)">1</button>${startPg>2?'<span class="pg-info">â€¦</span>':''}`;
    for(let p=startPg; p<=endPg; p++){
      pgHtml += `<button class="pg-btn${p===currentPage?' active':''}" onclick="goPage(${p})">${p}</button>`;
    }
    if(endPg < totalPages) pgHtml += `${endPg<totalPages-1?'<span class="pg-info">â€¦</span>':''}<button class="pg-btn" onclick="goPage(${totalPages})">${totalPages}</button>`;
    pgHtml += `<button class="pg-btn" onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>â€º</button>`;
    pgHtml += `<span class="pg-info">${list.length} coins Â· Trang ${currentPage}/${totalPages}</span>`;
    pgHtml += '</div>';
  }

  document.getElementById('tableArea').innerHTML=`
    <table>
      <thead><tr>
        <th style="width:34px">#</th><th>Coin</th>
        <th class="r">GiÃ¡</th><th class="r">24h %</th>
        <th class="r hide-sm">Cao 24h</th><th class="r hide-sm">Tháº¥p 24h</th>
        <th class="r hide-sm">KL 24h</th><th class="r hide-sm">Biáº¿n Äá»™ng</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${pgHtml}`;
}

function goPage(p){
  const totalCoins = SYMBOLS.filter(s=>coins[s]&&coins[s].price>0).length;
  const totalPages = Math.ceil(totalCoins / PAGE_SIZE);
  if(p<1||p>totalPages) return;
  currentPage = p;
  render();
  // Scroll table to top
  const scroll = document.querySelector('.table-scroll');
  if(scroll) scroll.scrollTop = 0;
}

function updateTicker(){
  const list = SYMBOLS.map(s=>({sym:s,base:s.replace('USDT',''),...coins[s]})).filter(c=>c.price>0);
  if(!list.length) return;
  const html = list.map(c=>{
    const cls = c.change24h>=0?'tup':'tdn';
    const logo = logoMap[c.base]
      ? `<img src="${logoMap[c.base]}" alt="${c.base}" width="14" height="14" style="border-radius:50%;object-fit:cover" loading="lazy">`
      : '';
    return `<span class="ticker-item">${logo}<span class="tsym">${c.base}</span><span>${fmtP(c.price)}</span><span class="${cls}">${sign(c.change24h)}${c.change24h.toFixed(2)}%</span></span>`;
  }).join('');
  document.getElementById('ticker').innerHTML = html+html;
}

function onSearch(){
  const val = document.getElementById('searchInput').value;
  document.getElementById('clearBtn').classList.toggle('visible', val.length > 0);
  currentPage = 1;
  render();
}

function clearSearch(){
  document.getElementById('searchInput').value = '';
  document.getElementById('clearBtn').classList.remove('visible');
  currentPage = 1;
  render();
}

function setTab(el,tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active'); currentTab=tab; currentPage=1; render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEWS â€” CoinGecko /news API (free, no proxy, CORS ok)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allNews = [], currentNewsSource = 'all', fetchingNews = false;

// Source filter mapping from CoinGecko news categories
const SOURCE_MAP = {
  'CoinDesk':     'coindesk',
  'CoinTelegraph':'cointelegraph',
  'Bitcoin Mag':  'bitcoin-magazine',
};

function detectSentiment(text){
  const t=(text||'').toLowerCase();
  const bull=['surge','rally','soar','gain','bull','rise','pump','ath','record','growth','breakout','positive','buy','adoption','approve','launch','upgrade','recover','milestone','partnership'];
  const bear=['crash','drop','fall','plunge','bear','decline','dump','loss','hack','ban','restrict','lawsuit','concern','risk','fear','sell','warning','exploit','fraud','scam','breach'];
  const bs=bull.filter(w=>t.includes(w)).length;
  const br=bear.filter(w=>t.includes(w)).length;
  return bs>br?'bullish':br>bs?'bearish':'neutral';
}

function extractCoins(text){
  const t=(text||'').toUpperCase();
  const found=[];
  ['BTC','ETH','BNB','SOL','XRP','DOGE','ADA','AVAX','DOT','LINK','UNI','MATIC','TRX','ARB','OP','APT','SUI','INJ','ATOM','NEAR','TON','SHIB'].forEach(c=>{
    if(new RegExp('\\b'+c+'\\b').test(t)&&!found.includes(c)) found.push(c);
  });
  return found.slice(0,4);
}

async function fetchNews(){
  if(fetchingNews) return;
  fetchingNews = true;
  const btn = document.getElementById('newsRefreshBtn');
  btn.disabled=true; btn.textContent='â³ Äang táº£i...';
  document.getElementById('newsFeed').innerHTML='<div class="news-loading"><div class="news-spinner"></div><div>Äang táº£i tin tá»©c...</div></div>';

  // Strategy: try multiple CoinGecko endpoints in order
  const strategies = [
    // Strategy 1: CoinGecko /news (correct â€” no per_page)
    async () => {
      const r = await fetch('https://api.coingecko.com/api/v3/news');
      if(!r.ok) throw new Error('news '+r.status);
      const d = await r.json();
      const arr = Array.isArray(d) ? d : (d.data||d.results||[]);
      if(!arr.length) throw new Error('empty');
      return arr.map(n => parseGeckoNewsItem(n));
    },
    // Strategy 2: CoinGecko trending + market data â†’ synthetic news
    async () => {
      const [trRes, mktRes] = await Promise.all([
        fetch('https://api.coingecko.com/api/v3/search/trending'),
        fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&price_change_percentage=1h,24h')
      ]);
      if(!trRes.ok && !mktRes.ok) throw new Error('both failed');
      const items = [];
      if(trRes.ok){
        const td = await trRes.json();
        (td.coins||[]).slice(0,7).forEach((entry,i)=>{
          const c = entry.item||{};
          const sym = (c.symbol||'').toUpperCase();
          const chg = c.data?.price_change_percentage_24h?.usd||0;
          const up  = chg>=0;
          items.push({
            headline: `${c.name||sym} Ä‘ang trending trÃªn CoinGecko â€” ${up?'tÄƒng':'giáº£m'} ${Math.abs(chg).toFixed(2)}% (24h)`,
            summary:  `${c.name||sym} lá»t vÃ o top tÃ¬m kiáº¿m toÃ n cáº§u. Háº¡ng vá»‘n hÃ³a: #${c.market_cap_rank||'â€”'}. Biáº¿n Ä‘á»™ng 24h: ${up?'+':''}${chg.toFixed(2)}%.`,
            source:   'CoinGecko Trending',
            link:     `https://www.coingecko.com/en/coins/${c.id||'bitcoin'}`,
            image:    c.thumb||c.small||'',
            pub:      Date.now()-i*12*60000,
            sentiment: chg>2?'bullish':chg<-2?'bearish':'neutral',
            coins:    sym?[sym]:[],
          });
        });
      }
      if(mktRes.ok){
        const md = await mktRes.json();
        (md||[]).slice(0,6).forEach((c,i)=>{
          const chg24 = c.price_change_percentage_24h||0;
          const chg1h = c.price_change_percentage_1h_in_currency||0;
          const up = chg24>=0;
          items.push({
            headline: `${c.name} (${(c.symbol||'').toUpperCase()}) ${up?'tÄƒng máº¡nh':'Ä‘iá»u chá»‰nh'} â€” GiÃ¡: $${c.current_price?.toLocaleString('en')||'â€”'}`,
            summary:  `Thá»‹ giÃ¡ hiá»‡n táº¡i $${c.current_price?.toLocaleString('en')||'â€”'}. Thay Ä‘á»•i 1h: ${chg1h>=0?'+':''}${chg1h.toFixed(2)}%, 24h: ${chg24>=0?'+':''}${chg24.toFixed(2)}%. Vá»‘n hÃ³a: $${c.market_cap?Math.round(c.market_cap/1e9)+'B':'â€”'}.`,
            source:   'CoinGecko Market',
            link:     `https://www.coingecko.com/en/coins/${c.id}`,
            image:    c.image||'',
            pub:      Date.now()-(i+7)*10*60000,
            sentiment: chg24>3?'bullish':chg24<-3?'bearish':'neutral',
            coins:    [(c.symbol||'').toUpperCase()].filter(Boolean),
          });
        });
      }
      if(!items.length) throw new Error('no items');
      return items;
    }
  ];

  let success = false;
  for(const strategy of strategies){
    try{
      const items = await strategy();
      allNews = items.filter(n=>n.headline);
      renderNews();
      success = true;
      break;
    }catch(e){
      console.warn('News strategy failed:', e.message);
    }
  }

  if(!success){
    document.getElementById('newsFeed').innerHTML=`
      <div class="news-loading">
        <div style="font-size:26px">âš ï¸</div>
        <div>KhÃ´ng thá»ƒ táº£i tin tá»©c lÃºc nÃ y.<br><small style="opacity:.6">CÃ³ thá»ƒ do giá»›i háº¡n API.</small><br><br>
        <button onclick="fetchNews()" style="margin-top:4px;padding:6px 14px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;font-family:inherit">â†» Thá»­ láº¡i</button></div>
      </div>`;
  }

  btn.disabled=false; btn.textContent='â†» LÃ m má»›i';
  fetchingNews=false;
}

function parseGeckoNewsItem(n){
  const pub = n.updated_at
    ? new Date(n.updated_at*1000).getTime()
    : n.created_at ? new Date(n.created_at*1000).getTime() : Date.now();
  const srcName = (n.author&&n.author.name)||n.news_site||n.source||'CoinGecko';
  return {
    headline:  (n.title||'').trim(),
    summary:   (n.description||n.text||'').replace(/<[^>]+>/g,'').trim().slice(0,180)+'â€¦',
    source:    srcName,
    link:      n.url||'#',
    image:     n.thumb_2x||n.thumb||n.image||'',
    pub,
    sentiment: detectSentiment((n.title||'')+' '+(n.description||'')),
    coins:     extractCoins((n.title||'')+' '+(n.description||'')),
  };
}

function renderNews(){
  const sentLabel={bullish:'ğŸ“ˆ TÃ­ch Cá»±c',bearish:'ğŸ“‰ TiÃªu Cá»±c',neutral:'âš–ï¸ Trung Láº­p'};
  let items = allNews;
  if(currentNewsSource!=='all'){
    items = items.filter(n=>n.source.toLowerCase().includes(currentNewsSource.toLowerCase()));
  }
  if(!items.length){
    document.getElementById('newsFeed').innerHTML='<div class="news-loading"><div>KhÃ´ng cÃ³ tin tá»©c tá»« nguá»“n nÃ y.</div></div>';
    return;
  }
  const html = items.map((n,i)=>{
    const tags=(n.coins||[]).map(c=>`<span class="news-coin-tag">${c}</span>`).join('');
    return `<a class="news-item" href="${n.link}" target="_blank" rel="noopener noreferrer">
      <div class="news-meta">
        <span class="news-src-tag">${n.source}</span>
        <span class="news-sentiment ${n.sentiment}">${sentLabel[n.sentiment]}</span>
        <span class="news-time">${timeAgo(n.pub)}</span>
      </div>
      <div class="news-headline">${n.headline}</div>
      ${n.summary?`<div class="news-summary">${n.summary}</div>`:''}
      ${tags?`<div class="news-coins">${tags}</div>`:''}
    </a>`;
  }).join('');
  document.getElementById('newsFeed').innerHTML=html;
}

function filterNews(el,src){
  document.querySelectorAll('.news-source-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active'); currentNewsSource=src; renderNews();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadTop100();
setInterval(render, 2000);
fetchNews();
setInterval(fetchNews, 5*60*1000);
</script>
</body>
</html>
